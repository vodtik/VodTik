import React, { useState, useEffect } from 'react';


export default function TikTokDownloader() {
const [url, setUrl] = useState('');
const [quality, setQuality] = useState('720');
const [watermark, setWatermark] = useState(true);
const [processing, setProcessing] = useState(false);
const [message, setMessage] = useState('');
const [history, setHistory] = useState([]);
const [dark, setDark] = useState(false);
const [lang, setLang] = useState('en');


useEffect(() => {
// load history and theme
const h = JSON.parse(localStorage.getItem('tt_history') || '[]');
setHistory(h.slice(0, 20));
const savedDark = localStorage.getItem('tt_dark') === 'true';
setDark(savedDark);
document.documentElement.classList.toggle('dark', savedDark);
}, []);


useEffect(() => {
localStorage.setItem('tt_history', JSON.stringify(history));
}, [history]);


function addToHistory(item) {
const next = [item, ...history.filter(h => h.url !== item.url)].slice(0, 20);
setHistory(next);
}


function validateUrl(text) {
// basic check
return /tiktok.com|vm.tiktok.com/.test(text);
}


async function handleDownload(type) {
if (!validateUrl(url)) {
setMessage('Please paste a valid TikTok video URL.');
return;
}
setProcessing(true);
setMessage('Processing...');


try {
const resp = await fetch('/api/download', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ url, quality, watermark, type }),
});


if (!resp.ok) {
const err = await resp.json().catch(() => ({}));
throw new Error(err.message || 'Server error');
}


const data = await resp.json();
// data: { fileUrl, filename }
}
